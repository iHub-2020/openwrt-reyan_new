#!/bin/sh
# Copyright (C) 2024 iHub-2020
#
# UCI defaults script for luci-app-udp-tunnel
# Sets up initial configuration with safe defaults for OpenWrt
#
# Version: 1.1.0
# Last Updated: 2026-01-10
#
# 注意：此脚本仅在首次安装时运行一次

# 只在 'general' section 不存在时创建
# 注意：必须使用 'general' 与 config.js 和 init.d 匹配
uci -q get udp2raw.general >/dev/null || {
	uci batch <<-EOF
		set udp2raw.general=general
		set udp2raw.general.enabled='0'
		set udp2raw.general.keep_rule='1'
		set udp2raw.general.wait_lock='1'
		set udp2raw.general.retry_on_error='1'
		set udp2raw.general.log_level='4'
		commit udp2raw
	EOF
}

# 重启 rpcd 使 ACL 生效
[ -x /etc/init.d/rpcd ] && /etc/init.d/rpcd reload 2>/dev/null

# 清除 LuCI 缓存
rm -rf /tmp/luci-* 2>/dev/null

exit 0