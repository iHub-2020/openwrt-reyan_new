# ==============================================================================
# Workflow: Build UDP-Tunnel IPKs
# Version: 2.5.4
#
# Changelog:
#   v2.5.4 - FIXED: ä½¿ç”¨ sed æš´åŠ›ä¿®æ”¹ libnl-tiny Makefile æºç åœ°å€ï¼Œå½»åº•è§£å†³ä¸‹è½½å¤±è´¥
#   v2.5.3 - FIXED: Force git redirect to GitHub mirrors
# ==============================================================================

name: build-udp-tunnel-ipks

on:
  workflow_dispatch:
    inputs:
      debug_build:
        description: 'Enable verbose build logs (V=s)'
        required: false
        default: 'true'
        type: boolean

permissions:
  contents: write
  actions: write

jobs:
  build:
    name: Build for ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            sdk_url: https://downloads.openwrt.org/releases/23.05.5/targets/x86/64/openwrt-sdk-23.05.5-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz
            sdk_name: openwrt-sdk-23.05.5-x86-64_gcc-12.3.0_musl.Linux-x86_64
          
          - arch: aarch64
            sdk_url: https://downloads.openwrt.org/releases/23.05.5/targets/rockchip/armv8/openwrt-sdk-23.05.5-rockchip-armv8_gcc-12.3.0_musl.Linux-x86_64.tar.xz
            sdk_name: openwrt-sdk-23.05.5-rockchip-armv8_gcc-12.3.0_musl.Linux-x86_64

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libncurses5-dev gawk git gettext libssl-dev xsltproc wget unzip python3 file zstd
          
          # ä¿ç•™è¿™ä¸ªé…ç½®ä½œä¸ºç¬¬ä¸€é“é˜²çº¿
          git config --global url."https://github.com/openwrt/".insteadOf "https://git.openwrt.org/project/"
          git config --global --add safe.directory '*'

      - name: Download and Extract OpenWrt SDK
        run: |
          wget -q -O sdk.tar.xz ${{ matrix.sdk_url }}
          tar -xf sdk.tar.xz
          mv ${{ matrix.sdk_name }} sdk

      - name: Update and Install Feeds
        working-directory: sdk
        run: |
          cat > feeds.conf << 'EOF'
          src-git-full base https://github.com/openwrt/openwrt.git;openwrt-23.05
          src-git packages https://github.com/openwrt/packages.git;openwrt-23.05
          src-git luci https://github.com/openwrt/luci.git;openwrt-23.05
          src-git routing https://github.com/openwrt/routing.git;openwrt-23.05
          EOF
          
          ./scripts/feeds update -a
          ./scripts/feeds install libnl-tiny lua luci-base luci-compat iptables kmod-ipt-raw
          
          # === ğŸ’€ ç»ˆæä¿®å¤ï¼šå¤–ç§‘æ‰‹æœ¯å¼ä¿®æ”¹ ===
          # ç›´æ¥ä¿®æ”¹ libnl-tiny çš„ Makefileï¼ŒæŠŠ git.openwrt.org æ›¿æ¢ä¸º github.com
          # è¿™æ · make download æ—¶ä¼šç›´æ¥å» GitHub ä¸‹è½½ï¼Œä¸å†ä¾èµ–ä¸ç¨³å®šçš„å®˜æ–¹æº
          echo "Patching libnl-tiny source URL..."
          sed -i 's|git\.openwrt\.org/project/libnl-tiny\.git|github.com/openwrt/libnl-tiny.git|g' package/feeds/base/libnl-tiny/Makefile
          
          # éªŒè¯ä¿®æ”¹æ˜¯å¦æˆåŠŸ
          grep "PKG_SOURCE_URL" package/feeds/base/libnl-tiny/Makefile

      - name: Prepare Package Sources
        run: |
          cp -R luci-app-udp-tunnel sdk/package/
          cp -R udp2raw sdk/package/
          
          # Fix Translation Symlinks
          cd sdk/package/luci-app-udp-tunnel/po
          if [ -d "zh_Hans" ] && [ ! -e "zh-cn" ]; then
            ln -sf zh_Hans zh-cn
            echo "âœ“ Created zh-cn -> zh_Hans symlink"
          fi

      - name: Extract Package Version
        id: version
        run: |
          PKG_VERSION=$(grep -m1 "^PKG_VERSION:=" luci-app-udp-tunnel/Makefile | cut -d'=' -f2)
          PKG_RELEASE=$(grep -m1 "^PKG_RELEASE:=" luci-app-udp-tunnel/Makefile | cut -d'=' -f2)
          echo "version=${PKG_VERSION}" >> $GITHUB_OUTPUT
          echo "release=${PKG_RELEASE}" >> $GITHUB_OUTPUT
          echo "âœ“ Detected: v${PKG_VERSION}-${PKG_RELEASE}"

      - name: Configure Build
        working-directory: sdk
        run: make defconfig

      - name: Compile udp2raw
        working-directory: sdk
        run: |
          make package/udp2raw/download V=s
          make package/udp2raw/compile V=s
          if ! find bin/packages -name "udp2raw*.ipk" | grep -q .; then
            echo "ERROR: udp2raw ipk not found!"
            exit 1
          fi

      - name: Compile luci-app-udp-tunnel
        working-directory: sdk
        env:
          PKG_VERSION: ${{ steps.version.outputs.version }}
          PKG_RELEASE: ${{ steps.version.outputs.release }}
        run: |
          echo "=== Downloading Dependencies ==="
          # è¿™é‡Œçš„ä¸‹è½½ç°åœ¨ä¼šèµ° GitHubï¼Œé€Ÿåº¦é£å¿«ä¸”ç¨³å®š
          make package/libnl-tiny/download V=s
          make package/luci-app-udp-tunnel/download V=s
          
          echo "=== Compiling ==="
          make package/luci-app-udp-tunnel/compile V=s
          
          if ! find bin/packages -name "luci-app-udp-tunnel*.ipk" | grep -q .; then
            echo "ERROR: luci-app-udp-tunnel ipk not found!"
            exit 1
          fi

      - name: Fix I18n Package Filename (if needed)
        working-directory: sdk
        run: |
          echo "=== Checking I18n Package Version ==="
          
          BROKEN_PKG=$(find bin/packages -name "luci-i18n-udp-tunnel-*unknown*.ipk" 2>/dev/null | head -n 1)
          
          if [ -n "$BROKEN_PKG" ]; then
            echo "âš  Found broken package: $(basename "$BROKEN_PKG")"
            
            MAIN_PKG=$(find bin/packages -name "luci-app-udp-tunnel_*.ipk" ! -name "*i18n*" | head -n 1)
            if [ -z "$MAIN_PKG" ]; then
              echo "ERROR: Cannot find main package to extract version"
              exit 1
            fi
            
            FULL_VERSION=$(basename "$MAIN_PKG" | sed 's/luci-app-udp-tunnel_\(.*\)_all\.ipk/\1/')
            echo "âœ“ Correct version: $FULL_VERSION"
            
            FIXED_PKG=$(echo "$BROKEN_PKG" | sed "s/unknown/${FULL_VERSION}/")
            mv "$BROKEN_PKG" "$FIXED_PKG"
            echo "âœ“ Renamed to: $(basename "$FIXED_PKG")"
          else
            echo "âœ“ No broken i18n packages found"
          fi
          
          echo ""
          echo "=== Final I18n Packages ==="
          find bin/packages -name "luci-i18n-udp-tunnel*.ipk" -exec basename {} \;

      - name: Organize Artifacts
        run: |
          mkdir -p artifacts
          find sdk/bin/packages -name "udp2raw*.ipk" -exec cp {} artifacts/ \;
          find sdk/bin/packages -name "luci-app-udp-tunnel*.ipk" -exec cp {} artifacts/ \;
          find sdk/bin/packages -name "luci-i18n-udp-tunnel*.ipk" -exec cp {} artifacts/ \;
          
          echo "=== Final Artifacts ==="
          ls -lh artifacts/

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: udp-tunnel-${{ matrix.arch }}
          path: artifacts/*.ipk
          retention-days: 7

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-files
          merge-multiple: true

      - name: Generate Release Tag
        id: tag
        run: echo "tag=v$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: UDP-Tunnel ${{ steps.tag.outputs.tag }}
          body: |
            ## UDP-Tunnel è‡ªåŠ¨æ„å»º
            
            æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp || github.event.repository.updated_at }}
            
            ### åŒ…å«æ–‡ä»¶
            - udp2raw (x86_64, aarch64)
            - luci-app-udp-tunnel (x86_64, aarch64)  
            - luci-i18n-udp-tunnel-zh-cn (ç®€ä½“ä¸­æ–‡ç¿»è¯‘)
            
            ### å®‰è£…
            ```bash
            opkg install udp2raw*.ipk luci-app-udp-tunnel*.ipk luci-i18n-udp-tunnel*.ipk
            ```
          files: release-files/*.ipk
          draft: false
          prerelease: false

  cleanup:
    name: Cleanup Old Artifacts
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Delete Old Artifacts
        uses: c-hive/gha-remove-artifacts@v1
        with:
          age: '1 day'
          skip-tags: false
          skip-recent: 6

      - name: Delete Old Releases
        uses: dev-drprasad/delete-older-releases@v0.3.4
        with:
          keep_latest: 3
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
