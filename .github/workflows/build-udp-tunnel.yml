# ==============================================================================
# Workflow: Build-UDP-Tunnel
# Description: Automated build pipeline for udp2raw and luci-app-udp-tunnel packages
#              using OpenWrt SDK for x86_64 and aarch64 architectures.
#
# Author: Reyanmatic
# Date: 2026-01-10
# Version: 1.6.0 (Fixed SDK URLs, improved feed reliability)
# License: MIT
# ==============================================================================

name: Build-UDP-Tunnel

on:
  workflow_dispatch:
    inputs:
      debug_build:
        description: 'Enable verbose build logs (V=s)'
        required: false
        default: 'true'
        type: boolean

jobs:
  build:
    name: Build for ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            sdk_url: https://downloads.openwrt.org/releases/23.05.5/targets/x86/64/openwrt-sdk-23.05.5-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz
            sdk_name: openwrt-sdk-23.05.5-x86-64_gcc-12.3.0_musl.Linux-x86_64
          
          - arch: aarch64
            sdk_url: https://downloads.openwrt.org/releases/23.05.5/targets/rockchip/armv8/openwrt-sdk-23.05.5-rockchip-armv8_gcc-12.3.0_musl.Linux-x86_64.tar.xz
            sdk_name: openwrt-sdk-23.05.5-rockchip-armv8_gcc-12.3.0_musl.Linux-x86_64

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libncurses5-dev gawk git gettext libssl-dev xsltproc wget unzip python3 file zstd
          git config --global --add safe.directory '*'

      - name: Download and Extract OpenWrt SDK
        run: |
          wget -q -O sdk.tar.xz ${{ matrix.sdk_url }}
          tar -xf sdk.tar.xz
          mv ${{ matrix.sdk_name }} sdk

      - name: Prepare Package Sources
        run: |
          cp -R udp2raw sdk/package/
          cp -R luci-app-udp-tunnel sdk/package/

      - name: Update and Install Feeds
        working-directory: sdk
        run: |
          # 使用 GitHub 镜像替代不稳定的 git.openwrt.org
          cat > feeds.conf << 'EOF'
          src-git-full base https://github.com/openwrt/openwrt.git;openwrt-23.05
          src-git packages https://github.com/openwrt/packages.git;openwrt-23.05
          src-git luci https://github.com/openwrt/luci.git;openwrt-23.05
          src-git routing https://github.com/openwrt/routing.git;openwrt-23.05
          EOF
          
          # 更新 feeds，带重试
          for i in 1 2 3; do
            ./scripts/feeds update -a && break
            echo "Retry $i..."
            sleep 10
          done
          
          [ -d "feeds/base" ] || { echo "feeds/base missing"; exit 1; }
          
          # 安装依赖
          ./scripts/feeds install luci-base luci-compat iptables

      - name: Configure Build
        working-directory: sdk
        run: |
          make defconfig

      - name: Compile udp2raw
        working-directory: sdk
        run: |
          make package/udp2raw/compile V=s IGNORE_ERRORS=1

      - name: Compile luci-app-udp-tunnel
        working-directory: sdk
        run: |
          make package/luci-app-udp-tunnel/compile V=s IGNORE_ERRORS=1

      - name: Organize Artifacts
        run: |
          mkdir -p artifacts
          find sdk/bin -name "*.ipk" -exec cp {} artifacts/ \;
          ls -la artifacts/

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: udp-tunnel-${{ matrix.arch }}
          path: artifacts/*.ipk
