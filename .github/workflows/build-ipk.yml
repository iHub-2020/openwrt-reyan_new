name: Build UDP Tunnel IPKs

on:
  push:
    paths:
      - 'udp2raw/**'
      - 'luci-app-udp-tunnel/**'
      - '.github/workflows/build-ipk.yml'
  workflow_dispatch:

jobs:
  build:
    name: Build for ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            sdk_url: https://downloads.openwrt.org/releases/23.05.5/targets/x86/64/openwrt-sdk-23.05.5-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz
            sdk_name: openwrt-sdk-23.05.5-x86-64_gcc-12.3.0_musl.Linux-x86_64
          
          - arch: aarch64
            # 使用 ARMv8 通用 SDK
            sdk_url: https://downloads.openwrt.org/releases/23.05.5/targets/armsr/armv8/openwrt-sdk-23.05.5-armsr-armv8_gcc-12.3.0_musl.Linux-x86_64.tar.xz
            sdk_name: openwrt-sdk-23.05.5-armsr-armv8_gcc-12.3.0_musl.Linux-x86_64

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libncurses5-dev gawk git gettext libssl-dev xsltproc wget unzip python3 file curl

      - name: Download and Extract OpenWrt SDK
        run: |
          wget -O sdk.tar.xz ${{ matrix.sdk_url }}
          tar -xf sdk.tar.xz
          mv ${{ matrix.sdk_name }} sdk

      - name: Prepare Package Sources
        run: |
          # 创建目录
          mkdir -p sdk/package/udp2raw
          mkdir -p sdk/package/luci-app-udp-tunnel
          
          # 复制文件 (使用 -R 递归复制内容)
          cp -R udp2raw/. sdk/package/udp2raw/
          cp -R luci-app-udp-tunnel/. sdk/package/luci-app-udp-tunnel/
          
          echo "Packages copied to SDK."
          ls -R sdk/package/udp2raw
          ls -R sdk/package/luci-app-udp-tunnel

      - name: Update and Install Feeds
        working-directory: sdk
        run: |
          # 更新 feeds
          ./scripts/feeds update -a
          
          # 安装基础依赖
          ./scripts/feeds install luci-base iptables luci-compat
          
          # 安装所有包的依赖 (防止漏掉)
          ./scripts/feeds install -a

      - name: Configure Build
        working-directory: sdk
        run: |
          make defconfig

      - name: Compile udp2raw
        working-directory: sdk
        run: |
          # 编译 udp2raw
          make package/udp2raw/compile V=s

      - name: Compile luci-app-udp-tunnel
        working-directory: sdk
        run: |
          # 编译 LuCI 界面
          make package/luci-app-udp-tunnel/compile V=s

      - name: Organize Artifacts
        run: |
          mkdir -p artifacts
          find sdk/bin/packages -name "udp2raw*.ipk" -exec cp {} artifacts/ \;
          find sdk/bin/packages -name "luci-app-udp-tunnel*.ipk" -exec cp {} artifacts/ \;
          find sdk/bin/packages -name "luci-i18n-udp-tunnel*.ipk" -exec cp {} artifacts/ \;

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: udp-tunnel-ipks-${{ matrix.arch }}
          path: artifacts/*.ipk
